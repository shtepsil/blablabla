<?php

namespace backend\controllers;

use backend\models\filters\OrderFilter;
use common\components\Debugger as d;
use backend\AdminController;
use backend\components\ProcessOrder\Appointment;
use backend\components\ProcessOrder\StateException;
use backend\components\ProcessOrder\Status\OrderStatusFactory;
use backend\models\retailcrm\EditCrmOrder;
use backend\models\SUser;
use common\components\retailcrm\ApiHelper;
use common\models\City;
use common\models\Items;
use common\models\Orders;
use common\models\OrdersHistory;
use common\models\OrdersItems;
use common\models\OrdersPay;
use common\models\OrdersRollbackItems;
use common\models\OrdersRollbackSets;
use common\models\OrdersSets;
use common\models\Pickpoint;
use common\models\Sets;
use common\models\User;
use common\models\UserAddress;
use shadow\helpers\StringHelper;
use shadow\widgets\AdminActiveForm;
use Yii;
use yii\base\Exception;
use yii\data\Pagination;
use yii\db\ActiveQuery;
use yii\filters\AccessControl;
use yii\filters\VerbFilter;
use yii\helpers\ArrayHelper;
use yii\helpers\Json;
use yii\helpers\Url;
use yii\web\BadRequestHttpException;
use yii\web\Response;
use common\models\ItemImg;

/**
 * Class OrdersController
 *
 * @package backend\controllers
 * @property Orders $model
 */
class OrdersController extends AdminController
{
    public $model;
    public function init()
    {
        $this->model       = new Orders();
        $this->url         = [
            'back'    => ['orders/index'],
            'control' => ['orders/control']
        ];
        $this->view->title = '–ó–∞–∫–∞–∑—ã';
        $this->MenuActive('orders');
        $this->breadcrumb[] = [
            'url'   => ['orders/index'],
            'label' => '–ó–∞–∫–∞–∑—ã'
        ];
        parent::init(); // TODO: Change the autogenerated stub
    }
    /**
     * @inheritdoc
     */
    public function behaviors()
    {
        return [
            'access' => [
                'class' => AccessControl::className(),
                'rules' => [
                    [
                        'allow' => true,
                        'roles' => ['loginAdminPanel'],
                    ],
                ],
            ],
            'verbs'  => [
                'class'   => VerbFilter::className(),
                'actions' => [
                    'control' => ['post', 'get'],
//                    'filter' => ['post', 'get'],
                ],
            ],
        ];
    }
    public function actionIndex()
    {
        $order = new Orders();
        $managers = ArrayHelper::map(SUser::find()
            ->select(['id', 'username'])
            ->where(['<>', 'role', 'admin'])
            ->orderBy(['username' => SORT_ASC])
            ->all(), 'id', 'username');
        $paymentType = $order->data_payment;

        if (empty($paymentType[0])) {
            unset($paymentType[0]);
        }

        $statuses = $order->data_status;
        $paymentStatuses = $order->data_pay_status;
        $pickpointsList = \common\models\Pickpoint::find()->orderBy(['city_id' => SORT_ASC, 'id' => SORT_ASC])->all();
        $pickpoints = [];

        if (!empty($pickpointsList)) {
            foreach ($pickpointsList as $pickpoint) {
                $pickpoints[$pickpoint->id] = $pickpoint->city.' ~ '.$pickpoint->name;
            }
        }

        $towns = ArrayHelper::map(City::find()->select(['id', 'name'])->all(), 'id', 'name');

        return $this->render('index', [
            'managers' => $managers,
            'paymentType' => $paymentType,
            'statuses' => $statuses,
            'paymentStatuses' => $paymentStatuses,
            'pickpoints' => $pickpoints,
            'towns' => $towns
        ]);
    }
    public function actionFilter()
    {
        /**
         * @var $items Orders[]
         */
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;

            $post = Yii::$app->request->post();
            $get = Yii::$app->request->get();
            $columns = $post['columns'];

            $q_all = new ActiveQuery(Orders::className());
//            $q_all->limit(100);

            if (!Yii::$app->user->can('admin') && !Yii::$app->user->can('manager')) {
                if (Yii::$app->user->can('collector')) {
                    $q_all->andWhere(['`orders`.status' => [1, 2, 3, 4]]);
                } elseif (Yii::$app->user->can('driver')) {
                    $q_all->andWhere(['`orders`.status' => [3, 4]]);
                }
            }

            $full_count = $q_all->count();

            $q = new ActiveQuery(Orders::className());
//            $q->limit(100);

            // —É—Å—Ç—Ä–∏—Ü—ã
            if (!empty($post['data'])) {
                $model = new OrderFilter();

                foreach ($post['data'] as $p) {
                    if (property_exists($model, $p['name'])) {
                        $model->{$p['name']} = $p['value'];
                    }
                }

                if (!empty($model->good)) {
                    $q->join('LEFT JOIN', 'orders_items', 'orders_items.order_id = orders.id');
                }

            }

            // ===================================================
            // –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –º–µ–Ω—é
            if(isset($get['filter_menu']) AND $get['filter_menu'] != 'all'){
                $q->where(['`orders`.status' => $get['filter_menu']]);
            }
            // ===================================================

            if (!Yii::$app->user->can('admin') && !Yii::$app->user->can('manager')) {
                if (Yii::$app->user->can('collector')) {
                    $q->andWhere(['`orders`.status' => [1, 2, 3, 4]]);
                } elseif (Yii::$app->user->can('driver')) {
                    $q->andWhere(['`orders`.status' => [3, 4, 5]]);
                }
            }
			
			$pickpoints = [];
            // –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –ø—É–Ω—Ç–∫—ã —Å–∞–º–æ–≤—ã–≤–æ–∑–∞ (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
			$pickpoints = Yii::$app->user->identity->findUserPickpoints(Yii::$app->user->identity->id);

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞–∫–∏–µ —Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
			if (!empty($pickpoints)) {

                // withOrdersOutPickpoints - –≤–∏–¥–∏—Ç —Ç–∞–∫ –∂–µ –∑–∞–∫–∞–∑—ã –±–µ–∑ –ø—É–Ω–∫—Ç–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
				if (Yii::$app->user->identity->withOrdersOutPickpoints == 1) {

                    // –ü–æ–ª—É—á–∏—Ç –∑–∞–∫–∞–∑—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø—É–Ω–∫—Ç —Å–∞–º–æ–≤—ã–≤–æ–∑–∞ —É–∫–∞–∑–∞–Ω
					$q->andWhere(['`orders`.pickpoint_id' => $pickpoints]);
                    // –ü–æ–ª—É—á–∏—Ç –∑–∞–∫–∞–∑—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø—É–Ω–∫—Ç —Å–∞–º–æ–≤—ã–≤–æ–∑–∞ –Ω–µ —É–∫–∞–∑–∞–Ω
                    // —Ç.–µ. –≤–æ—Ç —ç—Ç–∏ –∑–∞–∫–∞–∑—ã, –±–µ–∑ –ø—É–Ω–∫—Ç–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑–∞.
					$q->orWhere(['`orders`.pickpoint_id' => null]);
				} else {
                    // –ü–æ–ª—É—á–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞–∫–∞–∑—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø—É–Ω–∫—Ç —Å–∞–º–æ–≤—ã–≤–æ–∑–∞ —É–∫–∞–∑–∞–Ω.
					$q->andWhere(['`orders`.pickpoint_id' => $pickpoints]);
				}

                // –ü–æ–ª—É—á–∏—Ç –∑–∞–∫–∞–∑—ã, –∫ –∫–æ—Ç–æ—Ä—ã–º –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
				$q->orWhere(['`orders`.manager_id' => Yii::$app->user->identity->id]);
				
			}

            // withYandexWorkAndAll - –í–∏–¥–∏—Ç –Ø–Ω–¥–µ–∫—Å –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫–∞–∑—ã
			if (Yii::$app->user->identity->withYandexWorkAndAll == 0) {

                // withYandexWork - –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –Ø–Ω–¥–µ–∫—Å –∑–∞–∫–∞–∑—ã
				if (Yii::$app->user->identity->withYandexWork == 1) {
					$q->andWhere(['not', ['`orders`.delivery_method' => [0, 1, 3]]]);
				} else {
					if (Yii::$app->user->can('manager') &&
						!Yii::$app->user->can('admin') &&
						!Yii::$app->user->can('collector') &&
						!Yii::$app->user->can('senior_manager') &&
						!Yii::$app->user->can('kassir') &&
						!Yii::$app->user->can('driver')) {
						$q->andWhere(['not', ['`orders`.delivery_method' => 2]]);
					}
				}
			}

            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —á–µ–∫–±–æ–∫—Å "–í–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ–ø—Ç–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã"
            if(Yii::$app->user->identity->withIsWholesale == 1){
                /*
                 * ... —Ç—É—Ç –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ ->user->can()
                 */
                // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø—Ç–æ–≤—ã–µ.
                $q->andWhere(['>', '`orders`.isWholesale', 0]);
                $q->andWhere([
                    'in',
                    'user_id',
                    User::find()
                        ->select('id')
                        ->where(['manager_id' => Yii::$app->user->id])
                ]);
            }

            if ($model->validate()) {
                $fields = get_class_vars($model::className());

                foreach ($fields as $key => $v) {
                    if ($model->{$key} !== '') {
                        switch ($key) {
                            case 'order_create_start':
                                $q->andWhere(['>=', 'orders.created_at', $model->{$key}]);

                                break;
                            case 'order_create_end':
                                $q->andWhere(['<=', 'orders.created_at', $model->{$key}]);

                                break;
                            case 'order_delivery_start':
                                $q->andWhere(['>=', 'orders.date_delivery', $model->{$key}]);

                                break;
                            case 'order_delivery_end':
                                $q->andWhere(['<=', 'orders.date_delivery', $model->{$key}]);

                                break;
                            case 'manager':
                                $q->andWhere([
                                    'or',
                                    ['`orders`.manager_id' => $model->{$key}],
                                    ['`orders`.collector_id' => $model->{$key}],
                                    ['`orders`.driver_id' => $model->{$key}]
                                ]);
                                break;
                            case 'number':
                                $q->andWhere(['like', '`orders`.id', $model->{$key}]);
                                break;
                            case 'status':
                                $q->andWhere(['like', '`orders`.status', $model->{$key}]);
                                break;
                            case 'buyer_name':
                                $q->andWhere(['like', '`orders`.user_name', $model->{$key}]);
                                break;
                            case 'buyer_email':
                                $q->andWhere(['like', '`orders`.user_mail', $model->{$key}]);
                                break;
                            case 'buyer_phone':
                                $q->andWhere(['like', '`orders`.user_phone', $model->{$key}]);
                                break;
                            case 'sum_start':
                                $q->andWhere(['>=', 'orders.full_price', $model->{$key}]);

                                break;
                            case 'sum_end':
                                $q->andWhere(['<=', 'orders.full_price', $model->{$key}]);

                                break;
                            case 'payment_type':
                                $q->andWhere(['orders.payment' => $model->{$key}]);

                                break;
                            case 'payment_status':
                                $q->andWhere(['orders.pay_status' => $model->{$key}]);

                                break;
                            case 'delivery':
                                if ($model->{$key} == 1) {
                                    $q->andWhere(['orders.user_address' => '–°–∞–º–æ–≤—ã–≤–æ–∑']);
                                }
                                elseif ($model->{$key} == 3) {
                                    $q->andWhere(['orders.delivery_method' => 2]);
                                }
                                else {
                                    $q->andWhere(['<>', 'orders.user_address', '–°–∞–º–æ–≤—ã–≤–æ–∑']);
                                    $q->andWhere(['<>', 'orders.delivery_method', 2]);
                                }
                                break;
                            case 'pickpoint':
                                $q->andWhere(['orders.pickpoint_id' => $model->{$key}]);

                                break;
                            case 'town':
                                $q->andWhere(['orders.city_id' => $model->{$key}]);

                                break;
                            case 'good':
                                $q->andWhere(['like', 'orders_items.data', $model->{$key}]);

                                break;
                            default:

                                break;
                        }
                    }
                }

                $q->groupBy(['`orders`.id']);
            }

            if ($orders = $post['order']) {
                $q_order = [];
                foreach ($orders as $order) {
                    $name = $columns[$order['column']]['data'];
                    $q_order['`orders`.' . $name] = ($order['dir'] == 'asc') ? SORT_ASC : SORT_DESC;
                }

                if ($q_order) {
                    $q->orderBy($q_order);
                }
            }

            //echo $q->createCommand()->getRawSql();

            $count  = $q->count();
            $result = [
                'draw'            => (int)$post['draw'],
                'recordTotal'     => (int)$full_count,
                'recordsFiltered' => (int)$count
            ];
            if ($page = $post['start']) {
                $q->offset($page);
            }

            $q->limit($post['length']);

            $items           = $q->all();
            $data_items      = [];

            $default_columns = [
                'full_price',
                'id',
                'user_phone',
                'user_address',
                'payment',
                'pay_status',
                'pay_status_text',
				'bonus_use',
				'price_delivery_full',
				'isApp',
				'age_order'
            ];

            foreach ($items as $item) {
                $data_item = [];

                foreach ($columns as $column) {
                    $data_item[$column['data']] = $item->getRow($column['data']);
                }

                foreach ($default_columns as $val) {
					
					if (($item->created_at + 60) > time()) {
						$data_item['new_order_color'] = '#1d89cf';
					} else {
						$data_item['new_order_color'] = '';
					}

					if ($item->isApp) {
						$data_item['isApp'] = 'üì± ';
					} else {
						$data_item['isApp'] = '';
					}
					
					if ($val == 'price_delivery_full') {
						$full_price = str_replace(' ', '', $item->getRow('full_price'));
						
						$data_item[$val] = number_format((int)$item->getRow('price_delivery') + (int)$full_price - $item->getRow('bonus_use'), 0, '', ' ');												
					} else {
						 $data_item[$val] = $item->getRow($val);
					}
                }

                $data_items[] = $data_item;
            }

            $result['data'] = $data_items;

            return $result;
        } else {
            throw new BadRequestHttpException();
        }
    }
    public function actionItems()
    {
        /**
         * @var $items Items[]
         */
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            $result                     = [];
            $search                     = Yii::$app->request->get('search');
            $ids                        = Yii::$app->request->get('ids', []);
            $ids                        = array_diff($ids, ['']);
            $q                          = new ActiveQuery(Items::className());
            $q->where(
                [
                    'and',
                    ['not in', 'id', $ids],
                    [
                        'or',
                        ['like', 'name', $search],
                        ['like', 'id', $search]
                    ]
                ]
            );
            $q->limit(100);
            $items = $q->all();
            foreach ($items as $item) {
				
				if ($item->img_list == '') {
										  
					$itemImg = ItemImg::find()
					->andWhere(['item_id' => $item->id])
					->all();

				if (!empty($itemImg)) {
					$img_ = 'https://' . $_SERVER['HTTP_HOST'] . '/'.$itemImg[0]['url'];
				} else {
					$img_ = '';
				}
																						
				} else {					
					$img_ = 'https://' . $_SERVER['HTTP_HOST'] . '/'. $item->img_list;				
				}

                $result[] = [
                    'id'    => $item->id,
					'img'    => $img_,
                    'value' => $item->article . ' : ' . $item->name
                ];
            }
            return $result;
        } else {
            throw new BadRequestHttpException();
        }
    }
    public function actionAddItem($id)
    {
        /**
         * @var $items Items[]
         */
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            $item                       = Items::findOne($id);

            $item_params = [
                'item' => $item,
                'name' => 'ordersItems',
                'isWholesale' => Yii::$app->request->get('isWholesale')
            ];

            if(Yii::$app->request->get('order_id')) {
                $order = Orders::findOne(['id' => Yii::$app->request->get('order_id')]);
                $user = User::findOne($order->user_id);
                $item_params['user'] = $user;
                $item_params['user_id'] = $order->user_id;
            }

            $result                     = [
                'id'   => $id,
                'item' => $this->renderPartial('item', $item_params)
            ];

            return $result;
        } else {
            throw new BadRequestHttpException();
        }
    }
    public function actionSets()
    {
        /**
         * @var $items Sets[]
         */
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            $result                     = [];
            $search                     = Yii::$app->request->get('search');
            $ids                        = Yii::$app->request->get('ids', []);
            $ids                        = array_diff($ids, ['']);
            $q                          = new ActiveQuery(Sets::className());
            $q->where(
                [
                    'and',
                    ['not in', 'id', $ids],
                    [
                        'or',
                        ['like', 'name', $search],
                        ['like', 'id', $search]
                    ]
                ]
            );
            $q->limit(100);
            $items = $q->all();
            foreach ($items as $item) {
                $result[] = [
                    'id'    => $item->id,
                    'value' => $item->name
                ];
            }
            return $result;
        } else {
            throw new BadRequestHttpException();
        }
    }
    public function actionAddSet($id)
    {
        /**
         * @var $items Sets[]
         */
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            $item                       = Sets::findOne($id);
            $result                     = [
                'id'   => $id,
                'item' => $this->renderPartial('set', ['item' => $item, 'name' => 'ordersSets'])
            ];
            return $result;
        } else {
            throw new BadRequestHttpException();
        }
    }
    public function actionControl()
    {
        $item = $this->model;
        if ($id = \Yii::$app->request->get('id')) {
            $item = $item->findOne($id);
            if ($item) {
                $this->breadcrumb[] = [
                    'url'   => '#',
                    'label' => '–ó–∞–∫–∞–∑ ‚Ññ' . $item->id
                ];
            }
        } else {
            if ($user_id = Yii::$app->request->get('user_id')) {
                /**@var $user User */
                $user = User::findOne($user_id);
                if ($user) {
                    $item->user_id     = $user->id;
                    $item->user_name   = $user->username;
                    $item->user_mail   = $user->email;
                    $item->user_phone  = $user->phone;
                    $item->isEntity    = $user->isEntity;
                    $item->isWholesale = $user->isWholesale;
                    /**@var $a_address UserAddress */
                    $a_address = UserAddress::find()->andWhere(['user_id' => $user->id])->orderBy(['isMain' => SORT_DESC])->one();
                    if ($a_address) {
                        $item->user_address = '–≥.' . $a_address->data_city[$a_address->city] . ', —É–ª. ' . $a_address->street . ', –¥–æ–º. ' . $a_address->home . (($a_address->house) ? (', –∫–≤. ' . $a_address->house) : '');
                        $item->city_id      = $a_address->city;
                    }
                    if ($item->isWholesale == 1) {
                        $item->enable_bonus = 0;
                    }
                }
            }
        }

        $data['user'] = User::findOne($item->user_id);
        $data['item'] = $item;
        $data['user_types'] = User::$user_types;

        $pickpoints = Pickpoint::find()->orderBy(['city_id' => SORT_ASC, 'id' => SORT_ASC])->all();
        $data['pickpointsList'] = [];
        $data['pickpoints'] = [];

        if (!empty($pickpoints)) {
            foreach ($pickpoints as $pickpoint) {
                //$data['pickpoints'][$pickpoint->city_id][$pickpoint->id] = $pickpoint->name;
                $data['pickpoints'][$pickpoint->id] = $pickpoint->city.' ~ '.$pickpoint->name;
            }
        }

        if ($data['item']) {
            return $this->render('form', $data);
        } else {
            return false;
        }
    }
    public function actionLock($id)
    {
        $result = [];
        $record = Orders::findOne($id);
//        d::ajax('actionLock');
        if ($record) {

            if ($record->isDeadline) {

                Orders::updateAll(['isDeadline' => 0], ['like', 'id', $record->id]);

                $txt = '–ü—Ä–∏–Ω—è—Ç –∑–∞–∫–∞–∑, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–¥–∞–≤–Ω–æ –±—ã–ª –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –Ω–µ –ø—Ä–∏–Ω—è—Ç—ã–π';
                $txt .= "<b> –ú–µ–Ω–µ–¥–∂–µ—Ä ".Yii::$app->user->identity->username."</b>%0A";
                $txt .= "<b> –ó–∞–∫–∞–∑ ".$record->id."</b>%0A";
                $txt .= "<b> –ò–º—è ".$record->user_name."</b>%0A";
                $txt .= "%2B" . trim($record->user_phone)."%0A";
                $txt .= "<b> –í—Ä–µ–º—è ".date('H:i:s', $record->created_at)."</b>%0A";
                //	$txt .= "<b> –ú–µ—Ç–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏ ".$record->delivery_method."</b>%0A";
                $txt .= "<b>%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B</b>%0A";

                $token = '1713051743:AAElppnerY8-fjf4BpAoIMSJPW55bfLaOkI';

                $chat_id = '-531160281';

                $sendToTelegram = @fopen("https://api.telegram.org/bot{$token}/sendMessage?chat_id={$chat_id}&parse_mode=html&text={$txt}","r");
            }

            $appointment = new Appointment($record);
            try {
                /*
                 * –í –æ–±—â–µ–º —Ç—É—Ç, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞,
                 * –¥–ª—è —Ç–∏–ø–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∑–∞–∫–∞–∑–∞ –∑–∞–¥–∞—ë—Ç—Å—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∫–∏,
                 * —Ç.–µ. –≤ –∑–∞–∫–∞–∑–µ –µ—Å—Ç—å —Ç—Ä–∏ —Ç–∏–ø–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:
                 * manager_id, driver_id, collector_id
                 */
                $record = $appointment->lock(Yii::$app->user->identity);
                // –ò —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑.
//                d::ajax($record);
                $record->save(false);
                $result['status'] = 'success';
            } catch (StateException $e) {
                Yii::$app->response->statusCode = $e->getCode();
                $result['status']               = 'error';
                $result['message']              = $e->getMessage();
            }
        }
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            return $result;
        } else {
            return $this->redirect(Url::to(['orders/control', 'id' => $record->id]));
        }
    }
    public function actionUnLock($id)
    {
        $result = [];
        $record = Orders::findOne($id);
        if ($record) {
            $appointment = new Appointment($record);
            try {
                $record = $appointment->unlock(Yii::$app->user->identity);
                $record->save(false);
                $result['status'] = 'success';
            } catch (StateException $e) {
                Yii::$app->response->statusCode = $e->getCode();
                $result['status']               = 'error';
                $result['message']              = $e->getMessage();
            }
        }
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            return $result;
        } else {
            return $this->redirect(Url::to(['orders/control', 'id' => $record->id]));
        }
    }
    /**
     * @param $id
     *
     * @return array|Response
     */
    public function actionCheckPayStatus($id){
        $result = [];
        $record = Orders::findOne($id);
        if ($record) {
            try {
                Orders::checkPayStatus($record);
            } catch (\Throwable $e) {
                Yii::$app->response->statusCode = $e->getCode();
                $result['status']               = 'error';
                $result['message']              = $e->getMessage();
            }
        }
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            return $result;
        } else {
            return $this->redirect(Url::to(['orders/control', 'id' => $record->id]));
        }
    }
    public function actionNoPhone($id)
    {
        $result = [];
        $record = Orders::findOne($id);
        if ($no_phone = Yii::$app->request->post('no_phone')) {
            if ($no_phone == 1) {
                $record->status        = 9;
                $record->update_status = 9;
                $back                  = true;
            } elseif ($no_phone == 2) {
                $record->update_status = 13;
                if ($record->driver_id) {
                    $record->status = 3;
                } else {
                    $record->status = 0;
                }
            }
        }
    }
    public function actionFail($id)
    {
        $result = [];
        $record = Orders::findOne($id);
        if (Yii::$app->request->post('no')) {
            if ($record->status != 8) {
                $record->rollbackBonus();
            }
            $record->status        = 8;
            $back                  = true;
            $record->update_status = 14;
        }
    }

    public function actionOrderToShaping()
    {
        $post = Yii::$app->request->post();
//        d::ajax($post);
        $record = $this->model;
        $error_message = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞!';
        if ($id = Yii::$app->request->get('id')) {
            if(
                Yii::$app->user->can('admin')
                OR Yii::$app->user->can('senior_manager')
            ){
                $record = $record->findOne($id);
                $changeStatusFactory = new OrderStatusFactory();
                $changeStatus = $changeStatusFactory->createStatus($record, 1);
                try {
                    $record = $changeStatus->setStatusOrderToShaping();
                } catch (StateException $e) {
//                    Yii::$app->response->statusCode = $e->getCode();
                    $result['message']['error'] = $e->getMessage();
                    return $result;
                }
                $save = $record->save();
                if ($save) {
                    $result['message']['success'] = '–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ "–ö —Å–±–æ—Ä–∫–µ"!';
                } else {
                    $result['message']['error'] = $error_message;
                }
            }else{
                $result['message']['error'] = '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –¥–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ!';
            }
        }else{
            $result['message']['error'] = $error_message;
        }
        Yii::$app->response->format = Response::FORMAT_JSON;
        return $result;
    }

    public function actionLoadConsignmentNote($order_id)
    {
        $result = [];
        $record = Orders::findOne($order_id);
        if($record) {
            if($record->invoice_file == NULL){
                $record->saveFileAjax();
                $order = Orders::findOne($order_id);
                $result['message']['success'] = '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!';
                $result['invoice_file'] = $order->invoice_file;
            }else{
                $result['message']['warning'] = '–§–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.<br>–°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª!';
            }
        }else{
            Yii::$app->response->statusCode = 404;
            $result['message']['error'] = '–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞!';
        }
        $result['js'] = <<<JS
JS
        ;
        Yii::$app->response->format = Response::FORMAT_JSON;
        return $result;
    }

    /**
     * –û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ñ–∞–π–ª–æ–º –Ω–∞–∫–ª–∞–¥–Ω–æ–π
     * @return void
     */
    public function actionInvoice($order_id)
    {
        $post = Yii::$app->request->post();
//        d::ajax($post);
        $result = [];
        $record = Orders::findOne($order_id);

        if($record AND $record->invoice_file){
            $record->deleteFileAjax($record->invoice_file);
            $result['message']['success'] = '–§–∞–π–ª —É–¥–∞–ª—ë–Ω!';
        }else{
            Yii::$app->response->statusCode = 404;
            $result['message']['error'] = '–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞!';
        }
        $result['js'] = <<<JS
JS
        ;
        Yii::$app->response->format = Response::FORMAT_JSON;
        return $result;
    }

    /**
     * @throws Exception
     */
    public function actionSave()
    {
        $post = Yii::$app->request->post();
//        d::ajax($post);
        $record = $this->model;
//        d::ajax(get_class($record));
        $user_model = new User();
        $recordClassName = StringHelper::getPartStrByCharacter(get_class($record), '\\');
        // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∑–∞–∫–∞–∑ (–∫ –ø—Ä–∏–º–µ—Ä—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∑–∞–∫–∞–∑ –±—ã–ª –∏–∑–º–µ–Ω—ë–Ω)
        if ($id = Yii::$app->request->post('id')) {
            $record = $record->findOne($id);
            $user = $user_model::findOne($record->user_id);
        }else{
        // –ï—Å–ª–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
            $user_object = $user_model::find()
                ->where(['status' => User::STATUS_ACTIVE])
                /*
                 * –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Ç–æ,
                 * —á—Ç–æ–±—ã –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ –±—ã–ª –ø—É—Å—Ç.
                 * –ü–æ —ç—Ç–æ–º—É —É–ø—É—Å—Ç–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É.
                 */
                ->andWhere(['phone' => $post[$recordClassName]['user_phone']]);

            // –ê –ø–æ–ª–µ email –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ, –ø–æ —ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä–∏–º –µ–≥–æ —Ç—É—Ç.
            if($post[$recordClassName]['user_mail'] != ''){
                $user_object->orWhere(['email' =>  $post[$recordClassName]['user_mail']]);
            }
            $user = $user_object->one();
//            d::ajax($user);

            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ç–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            if(!$user){

                // —Ç—É—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –µ–≥–æ –≤ $user
                // –ü–æ—Ç–æ–º—É —á—Ç–æ –Ω–∏–∂–µ –Ω—É–∂–µ–Ω –±—É–¥–µ—Ç —Ç–∏–ø $user->isWholesale –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

                $user_model->isWholesale = $post[$recordClassName]['isWholesale'];
                $user_model->isEntity = $post[$recordClassName]['isEntity'];
                $user_model->city_id = $post[$recordClassName]['city_id'];
                $user_model->username = $post[$recordClassName]['user_name'];
                $user_model->email = $post[$recordClassName]['user_mail'];
                $user_model->phone = $post[$recordClassName]['user_phone'];
                $user_model->data = NULL;
                $user_model->status = $user_model::STATUS_ACTIVE;
                $user_model->password = \Yii::$app->security->generateRandomString(6);
                $user_model->generateAuthKey();
//                    $user_model->phone = '+7(333)-333-3333';

                if($user_model->save()){
                    $user_id = $user_model->id;
                }else{
                    Yii::$app->response->format = Response::FORMAT_JSON;
                    $result['message']['error'] = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!';
                    return $result;
                }
            }else{
                $user_id = $user->id;
            }

            $record->user_id = $user_id;
        }
//        d::ajax($user_id);
        /*
         * –¢–µ–ø–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±—É–¥–µ—Ç —Ç—É—Ç –Ω–∏–∂–µ, —Ç–∞–∫ –∫–∞–∫ $record->user_id - –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω –≤—Å–µ–≥–¥–∞.
         * —Ç.–µ. –≤—Å–µ –∑–∞–∫–∞–∑—ã —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
         */
        User::$id = $record->user_id;
        if(isset($user->isWholesale)) {
            User::$user_type = $user->isWholesale;
        }

        $is_manager   = $record->manager_id == Yii::$app->user->id;
        $is_collector = $record->collector_id == Yii::$app->user->id;
        $is_driver    = $record->driver_id == Yii::$app->user->id;

//        d::ajax($record->manager_id);

        $is_admin     = Yii::$app->user->can('admin');
        /**@var $user_panel \backend\models\SUser */
        $user_panel = Yii::$app->user->identity;
        if ($is_admin) {
            $record->scenario = 'admin';
        } else {
            if ($is_collector && $record->status < 5) {
                $record->scenario = 'collector';
            }
            if (($is_manager && $record->status == 0) || $record->isNewRecord) {
                $record->scenario = 'manager';
            }
        }
        if (in_array($record->status, [5, 6, 7])) {
            $result['message']['error'] = '–î–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑ —É–∂–µ –∑–∞–∫—Ä—ã—Ç';
            return $result;
        }

        if ($record->load(Yii::$app->request->post())) {
            if (Yii::$app->request->isAjax) {
                Yii::$app->response->format = Response::FORMAT_JSON;

                $ordersItems = Yii::$app->request->post('ordersItems');

                if (!empty($ordersItems)) {
                    foreach ($ordersItems as $result_) {

                        if ($result_['count'] == 0){
                            $result['message']['error'] = '–ö–æ–ª-–≤–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–≤–Ω—ã–º 0';
                            return $result;
                        }
                    }
                }

                if ($user_id = Yii::$app->request->post('user_id')) {
                    $record->user_id = $user_id;
                }

//                d::ajax(get_class($record));
                if ($errors = AdminActiveForm::validate($record)) {
                    $result['errors'] = $errors;
                } else {

                    $record->driver_id = isset(Yii::$app->request->post('Orders')['driver_id']) ? Yii::$app->request->post('Orders')['driver_id']: null;

                    $back = false;
                    $changeStatusFactory = new OrderStatusFactory();
                    if ($newStatus = Yii::$app->request->post('change_status')) {
                        $changeStatus = $changeStatusFactory->createStatus($record, $newStatus);
                        try {
                            $resultValidateChange = $changeStatus->validate();
                            if ($resultValidateChange !== true) {
                                return $resultValidateChange;
                            }
                            $record = $changeStatus->open();
                            $back   = true;
                        } catch (StateException $e) {
//                    Yii::$app->response->statusCode = $e->getCode();
                            $result['message']['error'] = $e->getMessage();
                            return $result;
                        }
                    }
                    if ($record->isNewRecord) {
                        if (Yii::$app->user->can('appointment_new')) {
                            $record->manager_id = Yii::$app->user->id;
                            $is_manager         = true;
                            $record->status     = 0;
                        }
                    }
                    if (!$record->manager_id) {
                        $result['message']['error'] = '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑!';
                        return $result;
                    }
                    if (!$is_admin && !$is_manager && !$is_collector && !\Yii::$app->user->can('force_set_status_success')) {
                        $result['message']['error'] = '–î–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑ —É–∂–µ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
                        return $result;
                    }
                    if (in_array($record->status, [0, 1, 2, 3, 4])) {
                        if ($is_admin || $is_collector || $is_manager || \Yii::$app->user->can('force_set_status_success')) {
                            $record->UpdateOrderItems();
                        } else {
                            $result['message']['error'] = '–î–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
                            return $result;
                        }
                    }
                    if (Yii::$app->request->post('commit')) {
                        $back = true;
                    }
                    $save = $record->save();
                    if ($save) {
                        if (\Yii::$app->params['RetailCRM']['enable'] === true) {
                            // update order in retailCRM
                            $crmOrder = new EditCrmOrder();
                            $crmOrder->prepare($record);
                            $crmApiHelper = new ApiHelper();
                            $crmApiHelper->updateOrder($crmOrder->attributes);
                        }
                        if ($is_collector || $is_manager) {
                            $record->saveOrderItems();
                        }
                        if ($back) {
                            $result['url'] = Url::to($this->url['back']);
                        } else {
                            $url           = $this->url['control'];
                            $url['id']     = $record->id;
                            $result['url'] = Url::to($url);
                        }
                        if (Yii::$app->request->post('send_message')) {
                            unset($result['url']);
                            $url_send_message = Json::encode(Url::to(['orders/send-message', 'id' => $record->id]));
                            $render_message   = $this->renderPartial('@common/mail/order', ['order' => $record]);
                            $html_message     = Json::encode('<form><textarea class="form-control" id="send_message_order" name="message" >' . $render_message . '</textarea></form>');
                            $result['js']     = <<<JS
var form = $({$html_message});

var box_message = bootbox.confirm(form, function (result) {
    if (result) {
        if (CKEDITOR && CKEDITOR.instances['send_message_order']) {
            CKEDITOR.instances['send_message_order'].updateElement();
        }
        var body_message = form.find('textarea').val();
        $.ajax({
            url: {$url_send_message},
            type: 'POST',
            data: $(form).serialize(),
            dataType: 'JSON',
            success: function (data) {
                $.growl.notice({title: '–û–ø–æ–≤–µ—â–µ–Ω–∏–µ', message: data.success});
            },
            error: function () {
                $.growl.error({title: '–û—à–∏–±–∫–∞', message: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞!", duration: 5000});
            }
        })
    }
});
box_message.on("shown.bs.modal", function () {
    CKEDITOR.replace('send_message_order', {
        //enterMode: 2,
        toolbar: 'Basic'
    });
});

JS;
                        } else {
                            if ($record->status < 5 && $record->payment == 2 && ($add_sum = $record->addSumPay())>0) {
                                $redirect_url = '';
                                if (isset($result['url'])) {
                                    $redirect_url = $result['url'];
                                    unset($result['url']);
                                }
                                $add_url_pay  = Json::encode(Url::to(['orders/send-pay', 'id' => $record->id]));
                                $result['js'] = <<<JS
    bootbox.confirm({
        message: '–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –æ–ø–ª–∞—Ç–∞ –≤ —Ä–∞–∑–º–µ—Ä–µ: <br/> {$add_sum} —Ç–µ–Ω–≥–µ',
        buttons: {
            confirm: {
                label: '–ó–∞–ø—Ä–æ—Å–∏—Ç—å –æ–ø–ª–∞—Ç—É',
                className: 'btn-success'
            },
            cancel: {
                label: '–ó–∞–∫—Ä—ã—Ç—å',
                className: 'btn-danger'
            }
        },
        callback: function (result) {
            if (result) {
                $.ajax({
                    url: {$add_url_pay},
                    type: 'GET',
                    dataType: 'JSON',
                    success: function (data) {
                        if (typeof data.error != 'undefined') {
                            $.growl.error({title: '–û—à–∏–±–∫–∞', message: data.error, duration: 5000});
                        }
                        if (typeof data.success != 'undefined') {
                            $.growl.notice({title: '–£—Å–ø–µ—Ö', message: message.success});
                            if (typeof data.url != 'undefined'){
                                bootbox.confirm({
                                    message: '–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º—É, –¥–ª—è —Ä—É—á–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É:<br/> '+data.url,
                                    buttons: {
                                        confirm: {
                                            label: '–û–∫'
                                        }
                                    },
                                    callback:function(result) {
                                        if ('{$redirect_url}'){
                                           window.location='{$redirect_url}';
                                        }
                                    }
                                })
                            }
                            // window.location.reload();
                        }
                    },
                    error: function () {
                        $.growl.error({title: '–û—à–∏–±–∫–∞', message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞!', duration: 5000});
                    }
                })

            }
        },
        className: "bootbox-sm"
    });
JS;
                            } else {
                                $result['message']['success'] = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
                            }
                        }
                        $result['set_value']['id']    = $record->id;
                        $result['message']['success'] = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
                    } else {
                        $result['message']['error'] = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!';
                    }
                }
                return $result;
            } else {
                $record->validate();
            }
        }
        if (!Yii::$app->request->isAjax) {
            return $this->goBack();
        }
    }
    public function actionRollbackItems($id)
    {
        /**
         * @var $item        Orders
         * @var $user        SUser
         * @var $target_item OrdersItems
         */
        $item = Orders::findOne($id);
        $user = Yii::$app->user->identity;
        if ($item && $item->status <= 4 && ($item->driver_id == $user->id || $item->manager_id == $user->id)) {
            if (Yii::$app->request->isAjax) {
                Yii::$app->response->format = Response::FORMAT_JSON;
                $main                       = new OrdersRollbackItems();
                $order_items                = $item->getOrdersItems()->indexBy('item_id')->all();
                $order_sets                 = $item->getOrdersSets()->indexBy('set_id')->all();
                $main->load(Yii::$app->request->post());
                $data_insert_items = $data_insert_sets = [];
                $rollback_items    = Yii::$app->request->post('ordersItems', []);
                $rollback_sets     = Yii::$app->request->post('ordersSets', []);
                if ($rollback_items) {
                    $i = 0;
                    foreach ($rollback_items as $key => &$val) {
                        $target_item = $order_items[$key];
                        $weight      = (isset($val['weight']) ? doubleval($val['weight']) : 0);
                        $count       = doubleval($val['count']);
                        $add_db      = true;
                        if ($count > $target_item->count) {
                            $error                      = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —á–µ–º –≤ –∑–∞–∫–∞–∑–µ<br>';
                            $error                      .= '–¢–æ–≤–∞—Ä:' . $target_item->item->name;
                            $error                      .= '<br>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∑–∞–∫–∞–∑–µ:' . $target_item->count;
                            $result['message']['error'] = $error;
                            return $result;
                        }
                        if ($weight > $target_item->weight) {
                            $error                      = '–í–µ—Å —Ç–æ–≤–∞—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —á–µ–º –≤ –∑–∞–∫–∞–∑–µ<br>';
                            $error                      .= '–¢–æ–≤–∞—Ä:' . $target_item->item->name;
                            $error                      .= '<br>–í–µ—Å –≤ –∑–∞–∫–∞–∑–µ:' . $target_item->weight;
                            $result['message']['error'] = $error;
                            return $result;
                        }
                        if ($main->type == 0) {
                            $count         = $target_item->count;
                            $weight        = $target_item->weight;
                            $val['weight'] = 0;
                            $val['count']  = 0;
                        } else {
                            if ($count < $target_item->count || $weight < $target_item->weight) {
                                $count         = $target_item->count - $count;
                                $weight        = $target_item->weight - $weight;
                                $val['weight'] = $target_item->weight - $weight;
                                $val['count']  = $target_item->count - $count;
                            } else {
                                $add_db = false;
                            }
                        }
                        if ($add_db) {
                            $data_insert_items[$i] = [
                                'order_id'      => $item->id,
                                'item_order_id' => $target_item->id,
                                'count'         => $count,
                                'weight'        => $weight,
                            ];
                        }
                        $i++;
                    }
                }
                if ($rollback_sets) {
                    $i = 0;
                    foreach ($rollback_sets as $key => &$val) {
                        $target_item = $order_sets[$key];
                        $count       = doubleval($val['count']);
                        $add_db      = true;
                        if ($count > $target_item->count) {
                            $error                      = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —á–µ–º –≤ –∑–∞–∫–∞–∑–µ';
                            $error                      .= '<br>–°–µ—Ç:' . $target_item->item->name;
                            $error                      .= '<br>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∑–∞–∫–∞–∑–µ:' . $target_item->count;
                            $result['message']['error'] = $error;
                            return $result;
                        }
                        if ($main->type == 0) {
                            $count        = $target_item->count;
                            $val['count'] = 0;
                        } else {
                            if ($count < $target_item->count) {
                                $count        = $target_item->count - $count;
                                $val['count'] = $target_item->count - $count;
                            } else {
                                $add_db = false;
                            }
                        }
                        if ($add_db) {
                            $data_insert_sets[$i] = [
                                'order_id'     => $item->id,
                                'set_order_id' => $target_item->id,
                                'count'        => $count,
                            ];
                        }
                        $i++;
                    }
                }
                $item->UpdateOrderItems($rollback_items, $rollback_sets, true);
                if ($main->type == 0) {
                    //–ø–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                    $item->status = 6;
                    $item->rollbackBonus();
                    $item->update_status = 8;
                } else {
                    //—á–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                    $item->status = 7;
                    $item->commitBonus();
                    $item->update_status = 7;
                }
                if ($item->save(false)) {
                    if ($data_insert_items) {
                        Yii::$app->db->createCommand()->batchInsert(OrdersRollbackItems::tableName(), [
                            'order_id',
                            'item_order_id',
                            'count',
                            'weight',
                        ], $data_insert_items)->execute();
                    }
                    if ($data_insert_sets) {
                        Yii::$app->db->createCommand()->batchInsert(OrdersRollbackSets::tableName(), [
                            'order_id',
                            'set_order_id',
                            'count',
                        ], $data_insert_sets)->execute();
                    }
                    $result['url'] = Url::to($this->url['back']);
                } else {
                    $result['message']['error'] = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!';
                }
                return $result;
            } else {
                $this->view->title = '–í–æ–∑–≤—Ä–∞—Ç';
                return $this->render('rollback_items', ['order' => $item]);
            }
        } else {
            throw new BadRequestHttpException();
        }
    }
    public function actionChangeItem()
    {
        $post = Yii::$app->request->post();
//        d::ajax($post);
        /**
         * @var $order_item  OrdersItems
         * @var $target_item Items
         */
        $user = null;
        if ($id = Yii::$app->request->post('id')) {
            $order = Orders::findOne(['id' => $id]);
            $user = User::findOne($order->user_id);
            User::$id = $order->user_id;
            if(isset($user->isWholesale)){
                User::$user_type = $user->isWholesale;
            }
        } else {
            $order = new Orders();
        }
        $order->isWholesale    = Yii::$app->request->post('isWholesale');
        $order->discount       = Yii::$app->request->post('discount');
        $order->price_delivery = Yii::$app->request->post('delivery');
        $sum                   = $full_bonus_manager = $full_purch_price = 0;
        $result_items          = $result_sets = [];
        $d = [];
        if ($items = Yii::$app->request->post('ordersItems')) {
            $db_items = Items::find()->indexBy('id')->where(['id' => array_keys($items)])->all();
            /**
             * @var $functions \frontend\components\FunctionComponent
             */
            $functions      = Yii::$app->function_system;
            $sessions_items = $order->to_session_items($items);
            $old_items      = [];
            if (!$order->isNewRecord) {
                $old_items = $order->getOrdersItems()->indexBy('item_id')->all();
                $db_items  = $order->convert_all_to_model($old_items, $db_items);
            }
            if (!trim($order->discount)) {
                if ($order->isWholesale == 0) {
                    $discount = $functions->discount_sale_items($db_items, $sessions_items);
                } else {
                    $discount = [];
                }
            } else {
                $discount = [];
            }

            foreach ($items as $key => $value) {
                $count      = doubleval($value['count']);
                $weight     = doubleval((isset($value['weight']) ? $value['weight'] : 0));
                $order_item = false;
                if (isset($old_items[$key])) {
                    // –°—é–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ –∑–∞–∫–∞–∑–µ
                    $order_item  = $old_items[$key];
                    $target_item = $db_items[$order_item->item_id];
                } else {
                    // –ó–¥–µ—Å—å —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –∑–∞–∫–∞–∑
                    $target_item = $db_items[$key];
                }

                if (isset($value['price'])) {
                    if ($target_item->discount) {
                        /*
                         * –ö–∞—Ä–æ—á–µ —è —Ç–∞–∫ –∏ –Ω–µ –ø–æ–Ω—è–ª, –∑–∞—á–µ–º —Ç—É—Ç —Å–∫–∏–¥–∫–∞ –æ–±–Ω—É–ª—è–µ—Ç—Å—è.
                         * –ü–æ–∫–∞ —É–±—Ä–∞–ª, —á—Ç–æ–±—ã –≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–ª–æ.
                         * –ü—Ä–æ—Å—Ç–æ –Ω–µ —Å—Ç–∞–ª —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è —Å —ç—Ç–∏–º –ø–æ–∫–∞ —á—Ç–æ. –ó–∞—á–µ–º —Ç—É—Ç 0 –Ω–∞ —Å–∫–∏–¥–∫—É –¥–µ–ª–∞–µ—Ç—Å—è.
                         */
//                        $target_item->discount = 0;
                    }
                    $target_item->price = (int)$value['price'];
                } else {
                    if ($target_item->discount) {
                        /*
                         * –ö–∞—Ä–æ—á–µ —è —Ç–∞–∫ –∏ –Ω–µ –ø–æ–Ω—è–ª, –∑–∞—á–µ–º —Ç—É—Ç —Å–∫–∏–¥–∫–∞ –æ–±–Ω—É–ª—è–µ—Ç—Å—è.
                         * –ü–æ–∫–∞ —É–±—Ä–∞–ª, —á—Ç–æ–±—ã –≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–ª–æ.
                         * –ü—Ä–æ—Å—Ç–æ –Ω–µ —Å—Ç–∞–ª —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è —Å —ç—Ç–∏–º –ø–æ–∫–∞ —á—Ç–æ. –ó–∞—á–µ–º —Ç—É—Ç 0 –Ω–∞ —Å–∫–∏–¥–∫—É –¥–µ–ª–∞–µ—Ç—Å—è.
                         */
//                        $target_item->discount = 0;
                    }
                    if ($order_item) {
                        $target_item->price = $order_item->price;
                    }
                }

                $item_price         = $target_item->sum_price($count, 'main', 0, $weight);
                $full_item_price    = $functions->full_item_price($discount, $target_item, $count, $weight);
                $full_bonus_manager += $target_item->full_price_bonus_manager($count, $weight, $discount);
                $discount_price     = '';
                if (isset($discount)) {
                    $discount_price = ($item_price - $full_item_price);
                    $item_price     = $item_price - $discount_price;
                }
                $result_items[$target_item->id] = [
                    'price'    => $item_price,
                    'discount' => $discount_price
                ];

                /*
                 * –í –∞–¥–º–∏–Ω–∫–µ, –≤ –∑–∞–∫–∞–∑–µ:
                 * –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –±—ã–ª–∞ –∑–∞–¥—É–º–∫–∞ –Ω–∞ —Ç–æ, —á—Ç–æ–±—ã –≤ –ø–æ–ª–µ "–¶–µ–Ω–∞ –∑–∞ –µ–¥." –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å —Ü–µ–Ω–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏,
                 * –ø–æ—Ç–æ–º –≤ –ø–æ–ª–µ "–°–∫–∏–¥–∫–∞" –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å —Å–∫–∏–¥–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ —Ç–æ–≤–∞—Ä—É.
                 * –ù–æ –ø–æ–∫–∞ —Ä–µ—à–∏–ª –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç —ç—Ç–æ–π –∑–∞—Ç–µ–∏, –∏ –Ω–µ —Å—Ç–∞–ª —É–¥–∞–ª—è—Ç—å —ç—Ç–æ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.
                 * –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è.
                 */
//                if($user AND isset($user->personal_discount[$target_item->id])){
//                    $user_opt_personal_discount = $user->personal_discount[$target_item->id];
//                    if(!preg_match('/%$/', $user->personal_discount[$target_item->id])){
//                        $user_opt_personal_discount = $user->personal_discount[$target_item->id] . '–¢–≥';
//                    }
//                    $result_items[$target_item->id]['discount'] = $user_opt_personal_discount;
//                }
                $sum += $item_price;
            }
        }

//        if(count($d)) d::ajax($d);
//        d::ajax('stop');

        /**
         * @var $db_sets  Sets[]
         * @var $old_sets OrdersSets[]
         */
        if ($sets = Yii::$app->request->post('ordersSets')) {
            $old_sets = [];
            if (!$order->isNewRecord) {
                $old_sets = $order->getOrdersSets()->indexBy('set_id')->all();
            }
            $db_sets = Sets::find()->indexBy('id')->where(['id' => array_keys($sets)])->all();
            foreach ($sets as $key => $value) {
                $count = doubleval($value['count']);
                if (isset($old_sets[$key])) {
                    $order_set = $old_sets[$key];
                    if (isset($value['price'])) {
                        $order_set->price = (int)$value['price'];
                    }
                    $target_set = $db_sets[$order_set->set_id];
                    $set_price  = round($count * $order_set->price);
                    unset($old_sets[$key]);
                } else {
                    $target_set = $db_sets[$key];
                    if (isset($value['price'])) {
                        $target_set->price = (int)$value['price'];
                    }
                    $set_price = round($count * $target_set->real_price());
                }
                $sum                          += $set_price;
                $bonus                        = $target_set->price_bonus_manager();
                $full_bonus_manager           += round($count * $bonus);
                $result_sets[$target_set->id] = [
                    'price' => $set_price
                ];
            }
        }
        $order->bonus_manager       = $full_bonus_manager - $order->discount($full_bonus_manager);
        $result                     = [
            'items'              => $result_items,
            'sets'               => $result_sets,
            'sum'                => $sum,
            'full_price'         => ((($sum + (int)$order->price_delivery) - $order->discount($sum)) - $order->bonus_use),
            'full_bonus_manager' => $order->bonus_manager
        ];
        Yii::$app->response->format = Response::FORMAT_JSON;
        return $result;
    }
    public function actionSendMessage()
    {
        if (Yii::$app->request->isAjax && ($id = Yii::$app->request->get('id'))) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            /**
             * @var $order Orders
             */
            $order             = Orders::findOne($id);
            $result            = [];
            $result['success'] = '–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
            if ($order && ($message = Yii::$app->request->post('message')) && $order->user_mail) {
                \Yii::$app->mailer->compose()
                    ->setHtmlBody($message)
                    ->setFrom([\Yii::$app->params['supportEmail'] => '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω ' . \Yii::$app->params['siteName'] . '.kz'])
                    ->setTo($order->user_mail)
                    ->setSubject('–û–ø–æ–≤–µ—â–µ–Ω–∏–µ —Å —Å–∞–π—Ç–µ ' . \Yii::$app->params['siteName'] . '.kz')->send();
            } elseif (!$order->user_mail) {
                $result['success'] = 'E-Mail –Ω–µ —É–∫–∞–∑–∞–Ω!';
            }
            return $result;
        } else {
            throw new BadRequestHttpException();
        }
    }

    public function actionPrintInvoicePayment()
    {
        if ($id = Yii::$app->request->get('id') AND !Yii::$app->user->isGuest) {
            $order_model = Orders::findOne(intval($id));
            if ($order_model) {
                $user = User::findOne($order_model->user_id);
                User::$user_type = $user->isWholesale;
                User::$id = $user->id;
                $db_items = Items::find()->where(['id' => array_keys($order_model->ordersItems)])->indexBy('id')->all();

                // =========================================================================

                $functions = Yii::$app->function_system;
                $order_items = $items = [];
                $user_discount
                    = $sum_user_discount
                    = $sum_with_discount
                    = $discount_price_items
                    = $sum_without_discount
                    = $count_order_items
                    = 0;

//                d::pex($order_model->ordersItems);

                if(count($order_model->ordersItems)){
                    $items = $order_model->convert_all_to_model($order_model->ordersItems, $db_items);
                    foreach($order_model->ordersItems as $order_item){
                        $order_data_item = $order_item->data_object;
                        $discount_price_item = 0;
                        /*
                         * –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –∏–º–µ–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å–∫–∏–¥–∫—É
                         * (–ª–∏–±–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –æ–ø—Ç–æ–≤—É—é –ª–∏–±–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –æ–±—ã—á–Ω—É—é)
                         * –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –æ–ø—Ç–æ–≤–∞—è —Ç–æ–∂–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ ->discount.
                         * –ê –µ—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –æ–ø—Ç–æ–≤–∞—è - –Ω–µ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å–∫–∏–¥–∫–∞, –∞ –ø—Ä–æ—Å—Ç–æ —Å—É–º–º–∞,
                         * —Ç–æ ->discount –±—É–¥–µ—Ç 0, –Ω–æ ->old_price –±—É–¥–µ—Ç –Ω–µ NULL, –Ω–æ –±—É–¥–µ—Ç —Ü–µ–Ω–æ–π –¥–æ –≤—ã—á–µ—Ç–∞ —Å–∫–∏–¥–∫–∏.
                         */
                        if($order_data_item->discount AND $order_data_item->old_price){
                            // –¶–µ–Ω–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏ —É–º–Ω–æ–∂–µ–Ω–Ω–∞—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                            $price_full_count = $functions->sum_price_count($order_data_item->old_price, $order_item->count);
                            // –°—É–º–º–∞ —Å–∫–∏–¥–∫–∏ —Ç–æ–≤–∞—Ä–∞ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–æ–π
                            $discount_price_item += $functions->discount($price_full_count, $order_data_item->discount);
                            // –°—É–º–º–∏—Ä—É–µ–º —Å—É–º–º—ã —Å–æ —Å–∫–∏–¥–∫–∞–º–∏ –≤ –æ–¥–Ω—É —Å—É–º–º—É. (—Ü–µ–Ω–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏ –ú–ò–ù–£–° —Å—É–º–º–∞ —Å–∫–∏–¥–∫–∏)
                            $sum_with_discount += ($price_full_count - $discount_price_item);
                            $item_full_sum = ($price_full_count - $discount_price_item);
                            // –°—É–º–º–∏—Ä—É–µ–º —Å–∫–∏–¥–∫–∏ –≤ –æ–¥–Ω—É —Å—É–º–º—É
                            $discount_price_items += $discount_price_item;
                        }else{
                            // –¶–µ–Ω–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏ —É–º–Ω–æ–∂–µ–Ω–Ω–∞—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

                            $sum_without_discount += $items[$order_data_item->id]->sum_price(
                                $order_item->count, 'main', 0, $order_item->weight
                            );
                            $item_full_sum = $items[$order_data_item->id]->sum_price(
                                $order_item->count, 'main', 0, $order_item->weight
                            );
                        }

                        $count_order_items++;
                        $order_items[$order_item->id] = [
                            'order_item' => $order_item,
                            'item' => $items[$order_data_item->id],
                            'item_full_price' => $item_full_sum,
                            'count_order_items' => $count_order_items
                        ];

                    }//foreach

                    // –†–∞—Å—á—ë—Ç —Å–∫–∏–¥–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    $sum_user_discount = $sum_without_discount;
                    $user_discount += $order_model->discount($sum_without_discount);
                    if ($user_discount > 0) {
                        $sum_user_discount -= $user_discount;
                    }
                }
                $order_full_price =
                    ($sum_user_discount + $sum_with_discount + $order_model->price_delivery)
                    - $order_model->bonus_use;

                // =========================================================================

                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±—É–¥—É—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                $user_requisites = $user;
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç—ã —Ä–æ–¥–∏—Ç–µ–ª—è
                if(!is_null($user->parent_data)){
                    $user_requisites = $user->parent_data;
                }

                $requisites = [];
                $attrs_requisites = EditRequisites::getAttrs();

                foreach($attrs_requisites as $k_requisite => $requisite){
                    /*
                     * –ü—Ä–∏—á–∏–Ω–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏–ª –æ–ø–∏—Å–∞–Ω–∞ —Ç—É—Ç
                     * frontend/controllers/UserController.php -> actionPrintInvoicePayment()
                     */
//                    if(!isset($user_requisites->$k_requisite)) continue;
                    $requisites[$k_requisite] = [
                        'name' => $requisite,
                        'value' => $user_requisites->$k_requisite
                    ];
                }

                $this->layout = 'empty';
                return $this->render('print/print-invoice-payment', [
                    'order' => $order_model,
                    'order_items' => $order_items,
                    'order_full_sum' => $order_full_price,
                    'requisites' => $requisites
                ]);
            } else {
                throw new BadRequestHttpException();
            }
        } else {
            throw new BadRequestHttpException();
        }
    }

    public function actionPrint($id)
    {
        $data         = [
            'order' => Orders::findOne($id)
        ];
        $this->layout = 'empty';
        return $this->render('print', $data);
    }
    public function actionExport($date_start, $date_end)
    {  
        $q = new ActiveQuery(Orders::className());
        if ($date_start) { 
            $date = \DateTime::createFromFormat('d.m.Y H:i:s', $date_start . ' 00:00:00', new \DateTimeZone(Yii::$app->timeZone));
            $q->andWhere(['>=', '`created_at`', $date->getTimestamp()]);
        }
        if ($date_end) {
            $date = \DateTime::createFromFormat('d.m.Y H:i:s', $date_end . ' 00:00:00', new \DateTimeZone(Yii::$app->timeZone));
            $q->andWhere(['<=', '`created_at`', $date->getTimestamp()]);
        }
	 
        $city_all = City::find()->indexBy('id')->all();
        /**
         * @var $users_all SUser[]
         */
        $users_all = SUser::find()->indexBy('id')->all();
        /** @var Orders[] $orders */
        $orders      = $q->orderBy(['created_at' => SORT_DESC])->all();		
		
		$data = "<table border='1'><tr>
		<td>id</td>
		<td>–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</td>
		<td>–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</td>
		<td>–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞</td>
		<td>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</td>
		<td>–¢–µ–ª–µ—Ñ–æ–Ω</td>
		<td>–ì–æ—Ä–æ–¥</td>
		<td>–ê–¥—Ä–µ—Å</td>
		<td>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</td>
		<td>–°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω –ø–ª–∞—Ç–µ–∂–∞</td>
		<td>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞</td>
		<td><table><tr>
		<td>–ê—Ä—Ç–∏–∫—É–ª</td>
		<td>–ù–∞–∑–≤–∞–Ω–∏–µ</td>
		<td>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</td>
		<td>–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º</td>
		<td>–ö–æ–ª-–≤–æ</td>
		<td>–í–µ—Å</td>
		<td>–¶–µ–Ω–∞</td>
		<td>–°–∫–∏–¥–∫–∞</td>
		<td>–ë–æ–Ω—É—Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</td>
		<td>–°—É–º–º–∞</td>
		</tr></table></td>
		<td>–°–∫–∏–¥–∫–∞ –Ω–∞ –∑–∞–∫–∞–∑</td>
		<td>–ò—Ç–æ–≥–æ</td>
		<td>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –±–æ–Ω—É—Å–æ–≤</td>
		<td>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞</td>
		<td>–°—Ç–∞—Ç—É—Å</td>
		<td>–ú–µ–Ω–µ–¥–∂–µ—Ä</td>
		</tr>";

        foreach ($orders as $order) {
            $data.= '<tr><td>' .$order->id. '</td><td>' .
                $order->getRow('created_at'). '</td><td>' .
                $order->getRow('date_delivery'). '</td><td>' .
                (($order->isEntity) ? '—é—Ä–ª–∏—Ü–æ' : '—á–∞—Å—Ç–Ω–æ–µ –ª–∏—Ü–æ'). '</td><td>' .
                (($order->user_name) ? $order->user_name : ''). '</td><td>' .
                (($order->user_phone) ? $order->user_phone : ''). '</td><td>' .
                ((isset($city_all[$order->city_id]) ? $city_all[$order->city_id]->name : '–ù–µ –≤—ã–±—Ä–∞–Ω')). '</td><td>' .
                (($order->user_address) ? $order->user_address : ''). '</td><td>' .
                $order->getRow('payment_text'). '</td><td>' .
                $order->getRow('pay_status_text'). '</td><td>' .
                (($order->user_comments) ? $order->user_comments : ''). '</td>';

            $order_items = OrdersItems::find()->with('item')->where(['order_id' => $order->id])->all();

            $functions = Yii::$app->function_system;
            $db_items  = $sessions_items = [];
            foreach ($order_items as $key => &$value) {
                $value->populateRelation('item', $order->convert_to_model($value, $value->item));
                $db_items[$value->item->id]       = $value->item;
                $sessions_items[$value->item->id] = $value->count;
            }
            if (!trim($order->discount)) {
                if ($order->isWholesale == 0) {
                    $discounts = $functions->discount_sale_items($db_items, $sessions_items);
                } else {
                    $discounts = [];
                }
            } else {
                $discounts = [];
            }

            if ($order_items) {
                $data.= '<td><table>';
                foreach ($order_items as $order_item) {

                    $count                 = (double)$order_item->count;
                    $price                 = $order_item->price;
                    $weight                = (double)$order_item->weight;

                    $data.= '<tr><td>' .$order_item->item->article. '</td>';
                    $data.= '<td>' .$order_item->item->name. '</td>';


                    $ordersItemsHandings = $order_item->ordersItemsHandings;
                    $result_handings     = '';
                    foreach ($ordersItemsHandings as $key => $ordersItemsHanding) {
                        if ($key > 0) {
                            $result_handings .= ', ';
                        }
                        $result_handings .= $ordersItemsHanding->typeHandling->name;
                    }
                    $data.= '<td>' .$result_handings. '</td>';
                    $data.= '<td>' .(($order_item->item->measure_price == 0) ? '–∫–≥' : '—à—Ç'). '</td>';

                    $data.= '<td>' .$count. '</td>';
                    $data.= '<td>' .(($order_item->item->measure_price != $order_item->item->measure) ? $weight : ''). '</td>';

                    $data.= '<td>' .$price. '</td>';

                    $item_sum_price = $order_item->item->sum_price($count, 'main', $price, $weight);
                    $discount       = 0;
                    if (isset($discounts) && $discounts) {
                        $item_price_discount = $functions->full_item_price($discounts, $order_item->item, $count, $weight);
                        $discount            = ($item_sum_price - $item_price_discount);
                        $item_sum_price      = $item_sum_price - $discount;
                    }

                    $data.= '<td>' .$discount. '</td>';
                    $data.= '<td>' .($order_item->item->full_price_bonus_manager($count, $weight, $discounts)). '</td>';
                    $data.= '<td>' .$item_sum_price. '</td></tr>';

                }
                $data.= '</table></td>';
            } else {
                $data.= '<td><table><tr><td></td>';
                $data.= '<td></td>';
                $data.= '<td></td>';
                $data.= '<td></td>';
                $data.= '<td></td>';
                $data.= '<td></td>';
                $data.= '<td></td>';
                $data.= '<td></td>';
                $data.= '<td></td>';
                $data.= '<td></td></tr></table></td>';
            }

            $data.= '<td>' .$order->discount. '</td>';
            $data.= '<td>' .(($order->full_price - $order->discount($order->full_price))). '</td>';

            $payment_state = '';
            $payment_method = '';
            // –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
            switch($order->payment){
                case 1:
                    $payment_method = '–ù–∞–ª–∏—á–Ω—ã–µ';
                    break;
                case 2:
                    $payment_method = '–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π';
                    if($order->pay_status){
                        $payment_state = $order->data_pay_status[$order->pay_status];
                    }
                    break;
                case 3:
                    $payment_method = '–ë–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏';
                    break;
            }

            $data.= '<td>' .$payment_method. '</td>';
            $data.= '<td>' .$payment_state. '</td>';

            $data.= '<td>' .$order->bonus_use. '</td>';
            $data.= '<td>' .(($order->admin_comments) ? $order->admin_comments : ''). '</td>';
            $data.= '<td>' .$order->getRow('status'). '</td>';
            $data.= '<td>' .((isset($users_all[$order->manager_id]) ? $users_all[$order->manager_id]->username : '–ù–µ—Ç')). '</td>';
            $data.='</tr>';
        }

        $data.= '</table>';

        $file = '1.xls';
        header("Content-type: application/vnd.ms-excel");
        header("Content-Disposition: attachment; filename=$file");
        echo "$data";
        exit();

        /*

        $excel       = new \moonland\phpexcel\Excel();
        $sheet       = new \PHPExcel();
        $activeSheet = $sheet->getActiveSheet();
        $row         = 1;
        $max_row     = 1;
        $colnum      = 0;
        $activeSheet->setCellValueByColumnAndRow($colnum, $row, 'id');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–¢–µ–ª–µ—Ñ–æ–Ω');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ì–æ—Ä–æ–¥');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ê–¥—Ä–µ—Å');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–û–ø–ª–∞—Ç–∞');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ê—Ä—Ç–∏–∫—É–ª');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ù–∞–∑–≤–∞–Ω–∏–µ');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ö–æ–ª-–≤–æ');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–í–µ—Å');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–¶–µ–Ω–∞');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–°–∫–∏–¥–∫–∞');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ë–æ–Ω—É—Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–°—É–º–º–∞');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–°–∫–∏–¥–∫–∞ –Ω–∞ –∑–∞–∫–∞–∑');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ò—Ç–æ–≥–æ');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –±–æ–Ω—É—Å–æ–≤');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–°—Ç–∞—Ç—É—Å');
        $activeSheet->setCellValueByColumnAndRow(++$colnum, $row, '–ú–µ–Ω–µ–¥–∂–µ—Ä');
        $row++;
        $max_row++;
        $col_num = 0;
        foreach ($orders as $order) {
            if ($row < $max_row) {
                $row = $max_row;
            }
            $col_num = 0;
            $activeSheet->setCellValueByColumnAndRow($col_num, $row, $order->id);
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, $order->getRow('created_at'));
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, $order->getRow('date_delivery'));
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, ($order->isEntity) ? '—é—Ä–ª–∏—Ü–æ' : '—á–∞—Å—Ç–Ω–æ–µ –ª–∏—Ü–æ');
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, ($order->user_name) ? $order->user_name : '');
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, ($order->user_phone) ? $order->user_phone : '');
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, (isset($city_all[$order->city_id]) ? $city_all[$order->city_id]->name : '–ù–µ –≤—ã–±—Ä–∞–Ω'));
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, ($order->user_address) ? $order->user_address : '');
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, $order->getRow('payment_text'));
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, ($order->user_comments) ? $order->user_comments : '');
            //region Items information
            $order_items = OrdersItems::find()->with('item')->where(['order_id' => $order->id])->all();
            $order_sets  = OrdersSets::find()->with('set')->where(['order_id' => $order->id])->all();

            $functions = Yii::$app->function_system;
            $db_items  = $sessions_items = [];
            foreach ($order_items as $key => &$value) {
                $value->populateRelation('item', $order->convert_to_model($value, $value->item));
                $db_items[$value->item->id]       = $value->item;
                $sessions_items[$value->item->id] = $value->count;
            }
            if (!trim($order->discount)) {
                if ($order->isWholesale == 0) {
                    $discounts = $functions->discount_sale_items($db_items, $sessions_items);
                } else {
                    $discounts = [];
                }
            } else {
                $discounts = [];
            }
            $start_multiple_row    = $row;
            $start_multiple_column = $col_num;
            if ($order_items) {
                foreach ($order_items as $order_item) {
                    $start_multiple_column = $col_num;
                    $count                 = (double)$order_item->count;
                    $price                 = $order_item->price;
                    $weight                = (double)$order_item->weight;
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $order_item->item->article);//–ê—Ä—Ç–∏–∫—É–ª
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $order_item->item->name);//–ù–∞–∑–≤–∞–Ω–∏–µ
                    $ordersItemsHandings = $order_item->ordersItemsHandings;
                    $result_handings     = '';
                    foreach ($ordersItemsHandings as $key => $ordersItemsHanding) {
                        if ($key > 0) {
                            $result_handings .= ', ';
                        }
                        $result_handings .= $ordersItemsHanding->typeHandling->name;
                    }
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $result_handings);//–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, ($order_item->item->measure_price == 0) ? '–∫–≥' : '—à—Ç');//–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $count);//–ö–æ–ª-–≤–æ
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, ($order_item->item->measure_price != $order_item->item->measure) ? $weight : '');//–í–µ—Å
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $price);//–¶–µ–Ω–∞
                    $item_sum_price = $order_item->item->sum_price($count, 'main', $price, $weight);
                    $discount       = 0;
                    if (isset($discounts) && $discounts) {
                        $item_price_discount = $functions->full_item_price($discounts, $order_item->item, $count, $weight);
                        $discount            = ($item_sum_price - $item_price_discount);
                        $item_sum_price      = $item_sum_price - $discount;
                    }
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $discount);//–°–∫–∏–¥–∫–∞
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $order_item->item->full_price_bonus_manager($count, $weight, $discounts));//–ë–æ–Ω—É—Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $item_sum_price);//–°—É–º–º–∞
                    $start_multiple_row++;
                }
            }
            if ($order_sets) {
                $start_multiple_row = $row;
                foreach ($order_sets as $order_set) {
                    $start_multiple_column = $col_num;
                    $count                 = (double)$order_set->count;
                    $price                 = $order_set->price;
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, '');//–ê—Ä—Ç–∏–∫—É–ª
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $order_set->set->name);//–ù–∞–∑–≤–∞–Ω–∏–µ
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, '');//–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, '—à—Ç');//–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $count);//–ö–æ–ª-–≤–æ
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, 0);//–í–µ—Å
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $price);//–¶–µ–Ω–∞
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, 0);//–°–∫–∏–¥–∫–∞
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, $order_set->price_bonus_manager());//–ë–æ–Ω—É—Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                    $activeSheet->setCellValueByColumnAndRow(++$start_multiple_column, $start_multiple_row, round($price * $count));//–°—É–º–º–∞
                    $start_multiple_row++;
                }
            }
            $max_row = $start_multiple_row;
            $col_num = $start_multiple_column;
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, $order->discount);//–°–∫–∏–¥–∫–∞ –Ω–∞ –∑–∞–∫–∞–∑
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, ($order->full_price - $order->discount($order->full_price)));//–ò—Ç–æ–≥–æ
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, $order->bonus_use);//–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –±–æ–Ω—É—Å–æ–≤
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, ($order->admin_comments) ? $order->admin_comments : '');
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, $order->getRow('status'));
            $activeSheet->setCellValueByColumnAndRow(++$col_num, $row, (isset($users_all[$order->manager_id]) ? $users_all[$order->manager_id]->username : '–ù–µ—Ç'));
            //endregion
            $row++;
            $max_row++;
        }
        //
        $activeSheet->getStyleByColumnAndRow(0, 1, $col_num, $row)->getAlignment()->setWrapText(true);
        for ($i = $row; $i >= 0; $i--) {
            $activeSheet->getRowDimension($i)->setRowHeight(30);
        }
        $col_num = 0;
        $activeSheet->getColumnDimensionByColumn($col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(10));//ID
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(20));//–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(20));//–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(30));//–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(40));//–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(40));//–¢–µ–ª–µ—Ñ–æ–Ω
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(30));//–ì–æ—Ä–æ–¥
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(50));//–ê–¥—Ä–µ—Å
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(40));//–û–ø–ª–∞—Ç–∞
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(40));//–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(20));//–ê—Ä—Ç–∏–∫—É–ª
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(60));//–ù–∞–∑–≤–∞–Ω–∏–µ
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(60));//–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(10));//–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(15));//–ö–æ–ª-–≤–æ
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(15));//–í–µ—Å
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(15));//–¶–µ–Ω–∞
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(20));//–°–∫–∏–¥–∫–∞
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(20));//–ë–æ–Ω—É—Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(20));//–°—É–º–º–∞
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(20));//–°–∫–∏–¥–∫–∞ –Ω–∞ –∑–∞–∫–∞–∑
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(20));//–ò—Ç–æ–≥–æ
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(20));//–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –±–æ–Ω—É—Å–æ–≤
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(60));//–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(40));//–°—Ç–∞—Ç—É—Å
        $activeSheet->getColumnDimensionByColumn(++$col_num)->setWidth(\PHPExcel_Shared_Drawing::pixelsToPoints(30));//–ú–µ–Ω–µ–¥–∂–µ—Ä

        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header('Content-Disposition: attachment;filename="export_orders.xls"');
        header('Cache-Control: max-age=0');
        $objectwriter = \PHPExcel_IOFactory::createWriter($sheet, 'Excel2007');
        $path         = 'php://output';
        $objectwriter->save($path);
        exit();
        */
    }
    public function actionTest()
    {
//        Yii::$app->response->format = Response::FORMAT_JSON;
        phpinfo();
        exit();
    }
    public function actionRollbackPay($id)
    {
        /**
         * @var $order Orders
         */
        $result = [];
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            $order                      = Orders::findOne($id);
            if ($order && $order->payment == 2 && $order->pay_status != 'success_rollback' && in_array($order->status, [6, 7])) {
                $sum_pay      = OrdersPay::find()->where(['order_id' => $order->id, 'status' => [0, 1]])->sum('amount');
                $order_sum    = $order->realSum();
                $rollback_sum = floatval($sum_pay);
                if ($order->status == 6) {//–ü–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                    $real_sum = 0;
                } else {//–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                    $rollback_sum = $sum_pay - $order_sum;
                    $real_sum     = $sum_pay - $rollback_sum;
                }
                $rollback_url_pay = Json::encode(Url::to(['orders/send-rollback-pay', 'id' => $order->id]));
                $result['js']     = <<<JS
    bootbox.confirm({
        message: '–°—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞: {$rollback_sum} <br/> –°—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è: {$real_sum}',
        buttons: {
            confirm: {
                label: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',
                className: 'btn-success'
            },
            cancel: {
                label: '–ó–∞–∫—Ä—ã—Ç—å',
                className: 'btn-danger'
            }
        },
        callback: function (result) {
            if (result) {
                $.ajax({
                    url: {$rollback_url_pay},
                    type: 'GET',
                    dataType: 'JSON',
                    success: function (data) {
                        if (typeof data.error != 'undefined') {
                            $.growl.error({title: '–û—à–∏–±–∫–∞', message: data.error, duration: 5000});
                        }
                        if (typeof data.success != 'undefined') {
                            window.location.reload();
                        }
                    },
                    error: function () {
                        $.growl.error({title: '–û—à–∏–±–∫–∞', message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞!', duration: 5000});
                    }
                })

            }
        },
        className: "bootbox-sm"
    });
JS;
            } else {
                $result['error'] = '–î–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏';
            }
        }
        return $result;
    }
    public function actionSendRollbackPay($id)
    {
        /**
         * @var $order Orders
         */
        $result = [];
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            $order                      = Orders::findOne($id);
            if ($order && $order->payment == 2 && $order->pay_status != 'success_rollback' && in_array($order->status, [6, 7])) {
                if ($order->status == 6) {//–ü–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                    $order->rollbackAllPay();
                } else {//–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                    $order->successPay();
                }
                Orders::updateAll(['pay_status' => 'success_rollback'], ['id' => $order->id]);
                $result['success'] = true;
            } else {
                $result['error'] = '–î–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏';
            }
        }
        return $result;
    }
    public function actionSendPay($id)
    {
        /**
         * @var $order Orders
         */
        $result = [];
        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            $order                      = Orders::findOne($id);
            if ($order && $order->payment == 2 && $order->pay_status != 'wait_surcharge' && ($add_sum = $order->addSumPay())) {
                if ($url = $order->sendAddPay($add_sum)) {
                    $result['success'] = '–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';
                    $result['url']     = $url;
                    $order->hand_link = $url;
                    $order->save();
                } else {
                    $result['error'] = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å';
                }
            } else {
                $result['error'] = '–î–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏';
            }
            return $result;
        } else {
            if ($result) {
                foreach ($result as $key => $value) {
                    \Yii::$app->session->setFlash($key, $value);
                }
            }
            return $this->goBack();
        }
    }

    /**
     * @param $id
     * @return array|void|Response
     * @throws BadRequestHttpException
     */
    public function actionDeleted($id)
    {
        throw new BadRequestHttpException();

    }

    /*
    * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    */
    public function actionCalltaxiinfo($id)
    {
        /**
         * @var $order Orders
         */
        $result = [];

        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            $order=Orders::findOne($id);

            $result['success']='–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';

            if (isset($order->coordinates_json_yandex) && ($order->coordinates_json_yandex != '')) {

                $params = array();

                $string = json_encode($params);

                $version = $order->version_edit;
                $claim_id = $order->claim_id;

                $ch = curl_init("https://b2b.taxi.yandex.net/b2b/cargo/integration/v1/claims/info?claim_id=$claim_id&version=$version");

                curl_setopt($ch, CURLOPT_HTTPHEADER, array(
                    'Content-Type: application/json',
                    'Accept-Language: en-US',
                    'Authorization: Bearer ' . \Yii::$app->params['bearer'],
                    'Content-Length: ' . strlen($string)
                ));
                curl_setopt($ch, CURLOPT_POSTFIELDS, $string);
                curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($params));
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
                curl_setopt($ch, CURLOPT_HEADER, false);
                $html = curl_exec($ch);
                curl_close($ch);
                $html = json_decode($html);

                $arr = ['new'=>'–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞.',
                    'estimating'=>	'–ò–¥–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ—Ü–µ–Ω–∫–∏ –∑–∞—è–≤–∫–∏ (–ø–æ–¥–±–æ—Ä —Ç–∏–ø–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –≥—Ä—É–∑–∞ –∏ —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏).',
                    'estimating_failed'=>	'–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É. –ü—Ä–∏—á–∏–Ω—É –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –≤ error_messages –≤ –æ—Ç–≤–µ—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ /info.',
                    'ready_for_approval'=>	'–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ü–µ–Ω–µ–Ω–∞ –∏ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞.',
                    'accepted'	=>'–ó–∞—è–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–æ–º.',
                    'performer_lookup'=>	'–ó–∞—è–≤–∫–∞ –≤–∑—è—Ç–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É. –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞.',
                    'performer_draft'=>	'–ò–¥–µ—Ç –ø–æ–∏—Å–∫ –≤–æ–¥–∏—Ç–µ–ª—è.',
                    'performer_found'=>	'–í–æ–¥–∏—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –∏ –µ–¥–µ—Ç –≤ —Ç–æ—á–∫—É –ê.',
                    'performer_not_found'=>	'–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–æ–¥–∏—Ç–µ–ª—è. –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.',
                    'pickup_arrived'=>	'–í–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–µ—Ö–∞–ª –≤ —Ç–æ—á–∫—É –ê.',
                    'ready_for_pickup_confirmation'	=>'–í–æ–¥–∏—Ç–µ–ª—å –∂–¥–µ—Ç, –∫–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –Ω–∞–∑–æ–≤–µ—Ç –µ–º—É –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.',
                    'pickuped'=>	'–í–æ–¥–∏—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–∞–ª –≥—Ä—É–∑.',
                    'pay_waiting'=>	'–ó–∞–∫–∞–∑ –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã (–∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è –æ–ø–ª–∞—Ç—ã –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏).',
                    'delivery_arrived'=>	'–í–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–µ—Ö–∞–ª –≤ —Ç–æ—á–∫—É –ë.',
                    'ready_for_delivery_confirmation'=>	'–í–æ–¥–∏—Ç–µ–ª—å –∂–¥–µ—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–∞–∑–æ–≤–µ—Ç –µ–º—É –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.',
                    'delivered'=>	'–í–æ–¥–∏—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–∏–ª –≥—Ä—É–∑.',
                    'delivered_finish' =>'–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω.',
                    'returning'=>	'–í–æ–¥–∏—Ç–µ–ª—é –ø—Ä–∏—à–ª–æ—Å—å –≤–µ—Ä–Ω—É—Ç—å –≥—Ä—É–∑ –∏ –æ–Ω –µ–¥–µ—Ç –≤ —Ç–æ—á–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞.',
                    'return_arrived'=>	'–í–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–µ—Ö–∞–ª –≤ —Ç–æ—á–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞.',
                    'ready_for_return_confirmation'=>	'–í–æ–¥–∏—Ç–µ–ª—å –≤ —Ç–æ—á–∫–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ–∂–∏–¥–∞–µ—Ç, –∫–æ–≥–¥–∞ –µ–º—É –Ω–∞–∑–æ–≤—É—Ç –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.',
                    'returned'=>	'–í–æ–¥–∏—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –≤–µ—Ä–Ω—É–ª –≥—Ä—É–∑.',
                    'returned_finish'=>	'–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω.',
                    'cancelled'=>	'–ó–∞–∫–∞–∑ –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω –∫–ª–∏–µ–Ω—Ç–æ–º –±–µ—Å–ø–ª–∞—Ç–Ω–æ.',
                    'cancelled_with_payment'=>	'–ó–∞–∫–∞–∑ –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω –∫–ª–∏–µ–Ω—Ç–æ–º –ø–ª–∞—Ç–Ω–æ (–≤–æ–¥–∏—Ç–µ–ª—å —É–∂–µ –ø—Ä–∏–µ—Ö–∞–ª).',
                    'cancelled_by_taxi'=>	'–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –∑–∞–∫–∞–∑ (–¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞).',
                    'cancelled_with_items_on_hands'	=>'–ö–ª–∏–µ–Ω—Ç –ø–ª–∞—Ç–Ω–æ –æ—Ç–º–µ–Ω–∏–ª –∑–∞—è–≤–∫—É –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≥—Ä—É–∑–∞ (–∑–∞—è–≤–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å —Ñ–ª–∞–≥–æ–º optional_return).',
                    'failed'	=>'–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –¥–∞–ª—å–Ω–µ–π—à–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.'];

                \Yii::$app->response->format = Response::FORMAT_JSON;
                $str_info = '';

                if (isset($html->taxi_offer->price)) {
                    $str_info.= ' –í–ù–ò–ú–ê–ù–ò–ï!!! –ó–∞—è–≤–∫–∞ –±—ã–ª–∞ –æ—Ü–µ–Ω–µ–Ω–∞ –≤ —Å—É–º–º—É = ' . $html->taxi_offer->price;
                }
                return [
                    'code'=>$arr[$html->status] . $str_info
                ];
            }
        }
    }

    /*
    * –≠—Ç–æ –≤–µ—Ä—Å–∏—è v2 —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
    */
    public function actionCalltaxi($id, $type, $repeat)
    {
        /**
         * @var $order Orders
         */
        $result = [];

        if (Yii::$app->request->isAjax) {

            Yii::$app->response->format = Response::FORMAT_JSON;

            $order = Orders::findOne($id);

            /*—â–∏—Ä–æ—Ç–∞ –º–µ–Ω—å—à–µ latitude*/
            if (isset($order->coordinates_json_yandex) && ($order->coordinates_json_yandex != '')) {
                // 	43.233781,76.935404			43.231757,76.89781     43.224729,76.93376
                $address_settings = [
                    '1' => [
                        'fullname' => '–ê–ª–º–∞—Ç—ã, —É–ª–∏—Ü–∞ –ê–π–º–∞–Ω–æ–≤–∞, 155',
                        'shortname' => '—É–ª–∏—Ü–∞ –ê–π–º–∞–Ω–æ–≤–∞, 155',
                        'lat'=> '76.89781',
                        'lon'=> '43.231757',


                    ],
                    '3' => [
                        'fullname' => '–ê–ª–º–∞—Ç—ã, –ø—Ä–æ—Å–ø–µ–∫—Ç –°–∞–∫–µ–Ω–∞ –°–µ–π—Ñ—É–ª–ª–∏–Ω–∞, 617',
                        'shortname' => '–ø—Ä–æ—Å–ø–µ–∫—Ç –°–∞–∫–µ–Ω–∞ –°–µ–π—Ñ—É–ª–ª–∏–Ω–∞, 617',
                        'lat'=> '76.935404',
                        'lon'=> '43.233781'
                    ]
                ];

                if (empty($order->pickpoint_id)) {
                    $pickpoint_id = '3';
                } else {
                    $pickpoint_id = $order->pickpoint_id;
                }

                $coord = explode(',', $order->coordinates_json_yandex);

                //	$destination_longitude = $coord[3];
                //	$destination_latitude = $coord[2];
                $destination_longitude = $address_settings[$pickpoint_id]['lat'];
                $destination_latitude = $address_settings[$pickpoint_id]['lon'];


                $source_longitude = $coord[1];
                $source_latitude = $coord[0];

                $user_data = explode(",", $order->user_address);

                $params = array(
                    'callback_properties' => array(
                        "callback_url"=> "https://kingfisher.kz/admin/orders/control.html?id=$id&"
                    ),
                    'client_requirements' => array(
                        //	"cargo_loaders"	=>	0,
                        //	"cargo_type"	=>	"lcv_m",
                        /*—Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏ express - –¥–æ—Å—Ç–∞–≤–∫–∞*/
                        "taxi_class"	=>	"express"
                        //		"taxi_class"	=>	"courier"

                    ),
                    'comment' => "Kingfisher",
                    //	'due' => "2021-01-28T00:00:00+00:00",
                    'emergency_contact' => array(
                        "cargo_loaders"	=>	0,
                        "name"	=> (isset(Yii::$app->user->identity->username) ? Yii::$app->user->identity->username : ''),
                        "phone"	=> (isset(Yii::$app->user->identity->phone) ? Yii::$app->user->identity->phone : '')
                    ),

                    'items' => array(
                        array(
                            "cost_currency"=>"KZT",
                            "cost_value"=> (string)$order->full_price,
                            "delivered_quantity"=>1,
                            "droppof_point"=> 2,
                            "extra_id"=> "–ë–ü-208",

                            "fiscalization"=> array(
                                /*
                                *	–ü—Ä–∏–∑–Ω–∞–∫ —Å–ø–æ—Å–æ–±–∞ —Ä–∞—Å—á–µ—Ç–∞ (https://yookassa.ru/developers/54fz/parameters-values#payment-mode)
                                *	full_prepayment	–ü–æ–ª–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞
                                *	partial_prepayment	–ß–∞—Å—Ç–∏—á–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞
                                *	advance	–ê–≤–∞–Ω—Å
                                *	full_payment	–ü–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç
                                *	partial_payment	–ß–∞—Å—Ç–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∏ –∫—Ä–µ–¥–∏—Ç
                                *	credit	–ö—Ä–µ–¥–∏—Ç
                                *	credit_payment	–í—ã–ø–ª–∞—Ç–∞ –ø–æ –∫—Ä–µ–¥–∏—Ç—É
                                */
                                "payment_mode"=> "advance",
                                "payment_subject"=> "service",
                                "vat_code"=> 1
                            ),

                            "pickup_point"=> 1,
                            "quantity"=> 1,
                            "size"=> array(
                                "height"=> 0.1,
                                "length"=> 0.1,
                                "width"=> 0.1
                            ),
                            "title"=> "–ó–∞–∫–∞–∑ Kingfisher",
                            "weight"=> 2
                        )
                    ),
                    "optional_return"=> false,
                    "referral_source"=> "yii2",
                    'requirements' => array(

                        'soft_requirements' => array(
                            array(
                                "logistic_group"=>  "ya_eats_group",
                                "meta_group"=>  "lavka",
                                "type"=> "performer_group"
                            )
                        ),
                        'strict_requirements' => array(
                            array(
                                "logistic_group"=> "ya_eats_group",
                                "meta_group"=> "lavka",
                                "type"=>  "performer_group"
                            )
                        )
                    ),
                    'route_points' => array(
                        /*—Ç–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è*/
                        array(
                            "address"=>array(
                                'coordinates' => array(
                                    (double)$destination_longitude, (double)$destination_latitude
                                ),
                                "building"=> "",
                                "city"=> "–ê–ª–º–∞—Ç—ã",
                                "comment"=> "–ö–æ–¥ –∏ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ —Ä–∞–≤–µ–Ω: " . $id,
                                "country"=> "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω",
                                "description"=> $address_settings[$pickpoint_id]['fullname'],
                                "door_code"=> "",
                                "flat"=>1,
                                "floor"=> 1,
                                "fullname"=> $address_settings[$pickpoint_id]['fullname'],
                                "porch"=> "",
                                "sflat"=> "",
                                "sfloor"=> "",
                                "shortname"=> $address_settings[$pickpoint_id]['shortname'],
                                "street"=> $address_settings[$pickpoint_id]['shortname'],
                                "uri"=> "ymapsbm1://geo?ll=" . (double)$destination_longitude . "%2C" . (double)$destination_latitude
                            ),
                            "contact"=>array(
                                "email"=>(isset(Yii::$app->user->identity->email) ? Yii::$app->user->identity->email : ''),
                                "name"=> (isset(Yii::$app->user->identity->username) ? Yii::$app->user->identity->username : ''),
                                "phone"=> (isset(Yii::$app->user->identity->phone) ? Yii::$app->user->identity->phone : '')
                            ),

                            /* "external_order_id"=> (string)$id,
                             "payment_on_delivery"=>array(
                               "client_order_id"=> "100",
                               "cost"=>"12.50",
                               "currency"=>"KZT",
                               "customer"=>array(
                                 "email"=> "stanislavkingfisher@gmail.com",
                                 "full_name"=> "–ê–ª–ª–∞",
                                 "inn"=>"1297578/20",
                                 "phone"=> "+77785670419"
                               ),
                               "tax_system_code"=> 1
                             ), */

                            //   "pickup_code"=> (string)$id,
                            //	   "pickup_code"=> "123456",
                            "point_id"=> 1,
                            "skip_confirmation"=> true,
                            /*
                            "time_intervals" => array(
                                array(
                                    "from"=>"2021-01-28T00:00:00+00:00",
                                    "to"=> "2021-01-28T00:00:00+00:00",
                                    "type"=>"perfect_match"
                                )
                            ),
                            */
                            /*source - –æ–∑–Ω–∞—á–∞–µ—Ç —Ç–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è*/
                            "type"=> "source",
                            "visit_order"=>1
                        ),
                        /*—Ç–æ—á–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è*/
                        array(
                            "address"=>array(
                                'coordinates' => array(
                                    (double)$source_longitude, (double)$source_latitude
                                ),
                                "building"=> "",
                                "city"=>"–ê–ª–º–∞—Ç—ã",
                                "comment"=> "–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: " . $id . ". " . $order->user_comments,
                                "country"=> "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω",
                                "description"=>$order->user_address,
                                "door_code"=> "",
                                "flat"=> (isset($user_data[2]) ? (integer)$user_data[2] : null),
                                "floor"=> 1,
                                "fullname"=> $order->user_address,
                                "porch"=> "",
                                "sflat"=> (isset($user_data[2]) ? $user_data[2] : ""),
                                "sfloor"=> "",
                                "shortname"=>   (isset($user_data[0]) ? $user_data[0] : null) . ', ' . (isset($user_data[1]) ? $user_data[1] : null) . ', ' . (isset($user_data[2]) ? $user_data[2] : null),
                                "street"=> (isset($user_data[0]) ? $user_data[0] : null). ', ' . (isset($user_data[1]) ? $user_data[1] : null) . ', ' . (isset($user_data[2]) ? $user_data[2] : null),
                                "uri"=> "ymapsbm1://geo?ll=" . (double)$source_longitude . "%2C" . (double)$source_latitude
                            ),
                            "contact"=>array(

                                //		"email"=> (string)(isset($order->user_mail) ? $order->user_mail : "stanislavkingfisher@gmail.com"),
                                "name"=> (string)(isset($order->user_name) ? $order->user_name : ""),
                                "phone"=>(string)(isset($order->user_phone) ? (str_replace(array( '(', ')' , '-'), '', $order->user_phone )) : ""),
                            ),
                            // "external_order_id"=> (string)$id,
                            // "payment_on_delivery"=>array(
                            // "client_order_id"=> "100",
                            // "cost"=>"12.50",
                            // "currency"=>"KZT",
                            // "customer"=>array(
                            // "email"=> "morty@yandex.ru",
                            // "full_name"=> "Morty",
                            // "inn"=>"3664069397",
                            // "phone"=> "79000000000"
                            // ),
                            // "tax_system_code"=> 1
                            // ),
                            //  "pickup_code"=> (string)$id,
                            //	"pickup_code"=> "123456",
                            "point_id"=> 2,
                            "skip_confirmation"=> true,
                            /*
                            "time_intervals" => array(
                                  array(
                                    "from"=>"2021-01-28T00:00:00+00:00",
                                    "to"=> "2021-01-28T00:00:00+00:00",
                                    "type"=>"perfect_match"
                                  )
                            ),
                            */
                            /*destination - –æ–∑–Ω–∞—á–∞–µ—Ç —Ç–æ—á–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è*/
                            "type"=> "destination",
                            /*–ø–æ—Ä—è–¥–æ–∫ –ø–æ—Å–µ—â–µ–Ω–∏—è —Ç–æ—á–∫–∏*/
                            "visit_order"=>2
                        )
                    ),

                    "skip_act"=> false,
                    "skip_client_notify"=>false,
                    /*false - –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –¥–≤–µ—Ä–∏*/
                    "skip_door_to_door"=> false,
                    "skip_emergency_notify"=> false
                );

                $string = json_encode($params);

                if ($type == 'create') {

                    $repeat_ = "";

                    if ($repeat) {
                        $repeat_ = time();
                    }

                    $ch = curl_init("https://b2b.taxi.yandex.net/b2b/cargo/integration/v2/claims/create?request_id=$id$repeat_");
                } elseif ($type == 'edit') {

                    $version = $order->version_edit;
                    $claim_id = $order->claim_id;

                    $ch = curl_init("https://b2b.taxi.yandex.net/b2b/cargo/integration/v2/claims/edit?claim_id=$claim_id&version=$version");
                }

                curl_setopt($ch, CURLOPT_HTTPHEADER, array(
                    'Content-Type: application/json',
                    'Accept-Language: en-US',
                    'Authorization: Bearer ' . \Yii::$app->params['bearer'],
                    'Content-Length: ' . strlen($string)
                ));
                curl_setopt($ch, CURLOPT_POSTFIELDS, $string);
                curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($params));
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
                curl_setopt($ch, CURLOPT_HEADER, false);
                $html = curl_exec($ch);
                curl_close($ch);
                $html = json_decode($html);

                \Yii::$app->response->format = Response::FORMAT_JSON;

                if ($type == 'create') {

                    if (isset($html->id)) {
                        $flag_claim_id = $order->claim_id;
                        $order->claim_id = $html->id;
                        $order->save();

                        $history_id = $order->changeHistory(16);
                        $ordersHistory = OrdersHistory::findOne($history_id);
                        $ordersHistory->claim_id = $html->id;
                        $ordersHistory->save();

                        $str = '';

                        if (!empty($flag_claim_id)) {
                            $str = '–±—ã–ª–∞';
                        }

                        return [
                            "code"=> "–°–æ–∑–¥–∞–Ω–∞ $str –∑–∞—è–≤–∫–∞: " . $html->id
                        ];
                    } else {
                        return [
                            "code"=> $html->message
                        ];
                    }
                } elseif ($type == 'edit') {

                    if (isset($html->code)) {
                        return [
                            'code'=> $html->message
                        ];

                    } else {
                        if (isset($html->id)) {
                            $order->version_edit = ($version + 1);
                            $order->save();

                            $history_id = $order->changeHistory(17);
                            $ordersHistory = OrdersHistory::findOne($history_id);
                            $ordersHistory->claim_id = $html->id . '. –í–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' . ($version + 1);
                            $ordersHistory->save();

                            return [
                                'code'=> '–û–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ' . $html->id . ' –í–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Ññ ' . ($version + 1)
                            ];
                        } else {
                            return [
                                "code"=> "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫...2"
                            ];
                        }
                    }
                }
            }else {
                \Yii::$app->response->format = Response::FORMAT_JSON;
                return [
                    'code'=>'–ó–∞–∫–∞–∑ –Ω–µ –∏–º–µ–µ—Ç —Ç–æ—á–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'
                ];
            }
        }
    }

    /*
    * –û—Ç–º–µ–Ω–∞
    */
    public function actionCalltaxicancel($id)
    {
        /**
         * @var $order Orders
         */
        $result = [];

        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            $order=Orders::findOne($id);

            if (isset($order->coordinates_json_yandex) && ($order->coordinates_json_yandex != '')) {

                $version = $order->version_edit;
                $claim_id = $order->claim_id;

                $params = array(
                    "cancel_state"	=>	"free",
                    "version"		=>	$version
                );

                $string = json_encode($params);
                $ch = curl_init("https://b2b.taxi.yandex.net/b2b/cargo/integration/v1/claims/cancel?claim_id=$claim_id");

                curl_setopt($ch, CURLOPT_HTTPHEADER, array(
                    'Content-Type: application/json',
                    'Accept-Language: en-US',
                    'Authorization: Bearer ' . \Yii::$app->params['bearer'],
                    'Content-Length: ' . strlen($string)
                ));
                curl_setopt($ch, CURLOPT_POSTFIELDS, $string);
                curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($params));
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
                curl_setopt($ch, CURLOPT_HEADER, false);
                $html = curl_exec($ch);
                curl_close($ch);
                $html = json_decode($html);

                \Yii::$app->response->format = Response::FORMAT_JSON;

                $history_id = $order->changeHistory(18);
                $ordersHistory = OrdersHistory::findOne($history_id);
                $ordersHistory->claim_id = $html->id . '. –í–µ—Ä—Å–∏—è: ' . $order->version_edit;
                $ordersHistory->save();

                return [
                    'code'=> '–†–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞—è–≤–∫–∞ —Å ‚Ññ ' . $html->id . ' –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å ' . $html->status
                ];

            }else {
                \Yii::$app->response->format = Response::FORMAT_JSON;
                return [
                    'code'=>'–ó–∞–∫–∞–∑ –Ω–µ –∏–º–µ–µ—Ç —Ç–æ—á–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'
                ];
            }
        }
    }

    /*
    * –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ - —Ä–µ–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ —Ç–∞–∫—Å–∏
    */
    public function actionCalltaxiaccept($id)
    {
        /**
         * @var $order Orders
         */
        $result = [];

        if (Yii::$app->request->isAjax) {
            Yii::$app->response->format = Response::FORMAT_JSON;
            $order=Orders::findOne($id);

            if (isset($order->coordinates_json_yandex) && ($order->coordinates_json_yandex != '')) {

                $version = $order->version_edit;
                $claim_id = $order->claim_id;

                $params = array(
                    "version"=>$version
                );

                $string = json_encode($params);

                $ch = curl_init("https://b2b.taxi.yandex.net/b2b/cargo/integration/v1/claims/accept?claim_id=$claim_id");

                curl_setopt($ch, CURLOPT_HTTPHEADER, array(
                    'Content-Type: application/json',
                    'Accept-Language: en-US',
                    'Authorization: Bearer ' . \Yii::$app->params['bearer'],
                    'Content-Length: ' . strlen($string)
                ));
                curl_setopt($ch, CURLOPT_POSTFIELDS, $string);
                curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($params));
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
                curl_setopt($ch, CURLOPT_HEADER, false);
                $html = curl_exec($ch);
                curl_close($ch);
                $html = json_decode($html);

                $history_id = $order->changeHistory(19);
                $ordersHistory = OrdersHistory::findOne($history_id);
                $ordersHistory->claim_id = $html->id . '. –í–µ—Ä—Å–∏—è: ' . $order->version_edit;
                $ordersHistory->save();

                if (isset($html->code)) {
                    return [
                        'code'=> '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫!!!'
                    ];
                } else {
                    return [
                        'code'=> '–í—ã–∑–æ–≤ —Å–æ–≤–µ—Ä—à–µ–Ω'
                    ];
                }
            }else {
                return [
                    'code'=>'–ó–∞–∫–∞–∑ –Ω–µ –∏–º–µ–µ—Ç —Ç–æ—á–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'
                ];
            }
        }
    }

    public function actionSetduplicate($id)
    {

        if (Yii::$app->request->isAjax) {

            $record = Orders::findOne($id);
            $status = $record->status;
            Orders::updateAll(['status' => 11], ['like', 'id', $id]);

            if ($status != 11) {
                $record->rollbackBonus();
                $history_id = $record->changeHistory(20);
            }

            $result['message'] = '–í—ã –∏–∑–º–µ–Ω–∏–ª–∏ —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ –Ω–∞ —Å—Ç–∞—Ç—É—Å –î—É–±–ª–∏–∫–∞—Ç';
            Yii::$app->response->format = Response::FORMAT_JSON;
            return $result;
        }
    }
}
